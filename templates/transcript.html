{% extends "layout.html" %}
{% block title %}Transcript for {{ bid_name }}{% endblock %}
{% block head_styles %}
<style>
  /* Ensure full utilization of width */
  .container-fluid {
    max-width: 98%;
  }

  /* PDF iframe occupies full width and proper height */
  .pdf-iframe {
    width: 100%;
    height: 95vh;
    border: none;
  }

  /* Responsive table with better width */
  .table-responsive {
    max-height: 60vh;
    overflow-y: auto;
  }

  /* Decision button styles - laid out horizontally */
  .btn-decision {
    font-size: 1.3rem;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s ease-in-out;
    border: none;
    background-color: transparent;
  }
  
  /* Styling for accept, reject, and ignore buttons */
  .btn-decision:hover {
    background: #f0f0f0;
  }

  /* Decision container to align buttons properly */
  .decision-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px; /* Adds space between buttons */
    white-space: nowrap;
  }

  /* Ensure tables use full width */
  .decision-table {
    width: 100%;
  }

  /* Adjust column sizes to distribute space properly */
  .col-custom {
    padding-left: 8px;
    padding-right: 8px;
  }

  /* Make sure the layout adjusts well for different screen sizes */
  @media (max-width: 992px) {
    .col-md-3, .col-md-6 {
      flex: 0 0 100%;
      max-width: 100%;
    }
    .pdf-iframe {
      height: 80vh;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <h1 class="text-center my-3">Transcript for {{ bid_name }}</h1>

  <!-- Bootstrap Grid Layout for better space utilization -->
  <div class="row">
    <!-- Left Column (Insertions) -->
    <div class="col-lg-3 col-md-4 col-sm-12 col-custom">
      <h3 class="text-center">Insertions</h3>
      {% if insertions %}
      <div class="table-responsive">
        <table class="table table-striped table-bordered decision-table">
          <thead class="table-success">
            <tr>
              <th>Text</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for insertion in insertions %}
            <tr data-id="ins-{{ loop.index }}">
              <td>{{ insertion }}</td>
              <td class="decision-container">
                <button class="btn-decision" onclick="handleDecision('accept', 'ins-{{ loop.index }}')" title="Accept">&#x2714;</button>
                <button class="btn-decision" onclick="handleDecision('reject', 'ins-{{ loop.index }}')" title="Reject">&#x2718;</button>
                <button class="btn-decision" onclick="handleDecision('ignore', 'ins-{{ loop.index }}')" title="Ignore">&#x2753;</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-center">No insertions available.</p>
      {% endif %}
    </div>

    <!-- Middle Column (PDF Viewer) -->
    <div class="col-lg-6 col-md-8 col-sm-12 col-custom">
      <h3 class="text-center">Transcript PDF</h3>
      {% if generated_pdf_url %}
      <iframe src="{{ generated_pdf_url }}" class="pdf-iframe" title="Generated Transcript PDF"></iframe>
      {% else %}
      <p class="text-center text-danger">Transcript PDF not available.</p>
      {% endif %}
    </div>

    <!-- Right Column (Deletions) -->
    <div class="col-lg-3 col-md-4 col-sm-12 col-custom">
      <h3 class="text-center">Deletions</h3>
      {% if deletions %}
      <div class="table-responsive">
        <table class="table table-striped table-bordered decision-table">
          <thead class="table-danger">
            <tr>
              <th>Text</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for deletion in deletions %}
            <tr data-id="del-{{ loop.index }}">
              <td>{{ deletion }}</td>
              <td class="decision-container">
                <button class="btn-decision" onclick="handleDecision('accept', 'del-{{ loop.index }}')" title="Accept">&#x2714;</button>
                <button class="btn-decision" onclick="handleDecision('reject', 'del-{{ loop.index }}')" title="Reject">&#x2718;</button>
                <button class="btn-decision" onclick="handleDecision('ignore', 'del-{{ loop.index }}')" title="Ignore">&#x2753;</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-center">No deletions available.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  function handleDecision(action, id) {
    if (!confirm(`Are you sure you want to ${action} change ${id}?`)) {
      return;
    }
    fetch(`/decision/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: action })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      return response.json();
    })
    .then(data => {
      alert(`Decision '${action}' recorded for ${id}.`);
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (row) {
        row.remove();
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("An error occurred while processing your decision.");
    });
  }
</script>
{% endblock %}
